<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Base64 â†’ File (Local or Drive via Redis-backed server)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #0f172a;
        --panel: #111827;
        --text: #e5e7eb;
        --muted: #94a3b8;
        --ok: #22c55e;
        --warn: #f59e0b;
        --err: #ef4444;
        --accent: #2563eb;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        min-height: 100vh;
        display: grid;
        place-items: center;
        background: var(--bg);
        color: var(--text);
        font:
          16px/1.45 system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Arial,
          sans-serif;
      }
      .card {
        width: min(900px, 92vw);
        background: var(--panel);
        border: 1px solid #1f2937;
        border-radius: 12px;
        padding: 20px;
      }
      h1 {
        margin: 0 0 6px;
        font-size: 22px;
      }
      p {
        margin: 0.2rem 0 1rem;
        color: var(--muted);
      }
      .row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }
      textarea {
        width: 100%;
        height: 180px;
        resize: vertical;
        background: #0b1220;
        color: var(--text);
        border: 1px solid #263043;
        border-radius: 8px;
        padding: 10px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      }
      input[type="text"] {
        background: #0b1220;
        color: var(--text);
        border: 1px solid #263043;
        border-radius: 8px;
        padding: 10px;
      }
      .btn {
        appearance: none;
        border: 0;
        border-radius: 8px;
        padding: 10px 14px;
        font-weight: 600;
        color: white;
        background: var(--accent);
        cursor: pointer;
      }
      .btn.secondary {
        background: #374151;
      }
      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .status {
        margin-top: 10px;
        padding: 10px;
        border-radius: 8px;
        background: #0b1220;
        border: 1px solid #263043;
        white-space: pre-wrap;
        word-break: break-word;
      }
      .ok {
        color: var(--ok);
      }
      .warn {
        color: var(--warn);
      }
      .err {
        color: var(--err);
      }
      label {
        color: var(--muted);
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      @media (max-width: 720px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Base64 to File</h1>
      <p>
        Paste Base64; download locally or upload to Google Drive through your
        local server. No Google secrets in this page.
      </p>

      <label for="b64">Base64 input</label>
      <textarea
        id="b64"
        placeholder="Raw Base64 or data:...;base64,...."
      ></textarea>

      <div class="grid" style="margin-top: 10px">
        <div class="row"><label for="filename">Output filename</label></div>
        <div class="row"><label for="mime">MIME type (optional)</label></div>
        <input id="filename" type="text" placeholder="example.bin" />
        <input
          id="mime"
          type="text"
          placeholder="e.g. application/pdf or image/png"
        />
      </div>

      <div class="row" style="margin-top: 14px">
        <button id="btnDownload" class="btn">Convert and Download</button>
        <button id="btnAuth" class="btn secondary">Authorize Google</button>
        <button id="btnUpload" class="btn" disabled>
          Convert and Upload to Drive
        </button>
      </div>

      <div id="status" class="status">Ready.</div>
    </div>

    <script>
      const statusEl = document.getElementById("status");
      const b64El = document.getElementById("b64");
      const nameEl = document.getElementById("filename");
      const mimeEl = document.getElementById("mime");
      const btnDownload = document.getElementById("btnDownload");
      const btnAuth = document.getElementById("btnAuth");
      const btnUpload = document.getElementById("btnUpload");

      function setStatus(msg, level) {
        statusEl.textContent = msg;
        statusEl.classList.remove("ok", "warn", "err");
        if (level) statusEl.classList.add(level);
      }

      function parseInput(raw) {
        const s = raw.trim();
        const idx = s.indexOf("base64,");
        if (idx >= 0 && s.startsWith("data:")) {
          const header = s.slice(5, idx - 1);
          const mime = header.split(";")[0] || "";
          const payload = s.slice(idx + 7);
          return { mime: mime || "", base64: payload };
        }
        return { mime: "", base64: s.replace(/\s+/g, "") };
      }

      function base64ToBlob(b64, mime = "") {
        const byteChars = atob(b64);
        const part = 1024 * 1024;
        const parts = [];
        for (let i = 0; i < byteChars.length; i += part) {
          const slice = byteChars.slice(i, i + part);
          const bytes = new Uint8Array(slice.length);
          for (let j = 0; j < slice.length; j++) bytes[j] = slice.charCodeAt(j);
          parts.push(bytes);
        }
        return new Blob(parts, { type: mime || "application/octet-stream" });
      }

      function downloadBlob(blob, name) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = name || "file.bin";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      async function checkAuth() {
        try {
          const resp = await fetch("/api/status", { credentials: "include" });
          const js = await resp.json();
          if (js.authed) {
            btnUpload.disabled = false;
            setStatus("Google authorization present; you can upload.", "ok");
          } else {
            btnUpload.disabled = true;
            setStatus("Not authorized with Google yet.", "warn");
          }
        } catch (e) {
          setStatus("Server not reachable. Start the container.", "err");
        }
      }

      btnAuth.addEventListener("click", () => {
        window.open("/oauth/start", "_blank", "width=500,height=650");
        setStatus(
          "Complete Google consent in the popup; then return here and click Upload.",
          "warn"
        );
        setTimeout(checkAuth, 2000);
      });

      btnDownload.addEventListener("click", () => {
        try {
          const { mime: mFrom, base64 } = parseInput(b64El.value);
          if (!base64) {
            setStatus("No Base64 to convert.", "warn");
            return;
          }
          const name = (nameEl.value || "file.bin").trim();
          const mime = (
            mimeEl.value ||
            mFrom ||
            "application/octet-stream"
          ).trim();
          const blob = base64ToBlob(base64, mime);
          downloadBlob(blob, name);
          setStatus(`Saved ${name} locally.`, "ok");
        } catch (e) {
          console.error(e);
          setStatus("Conversion failed. See console for details.", "err");
        }
      });

      btnUpload.addEventListener("click", async () => {
        try {
          const { mime: mFrom, base64 } = parseInput(b64El.value);
          if (!base64) {
            setStatus("No Base64 to convert.", "warn");
            return;
          }
          const name = (nameEl.value || "file.bin").trim();
          const mime = (
            mimeEl.value ||
            mFrom ||
            "application/octet-stream"
          ).trim();

          setStatus("Uploading to Google Drive...", null);
          const resp = await fetch("/api/drive/upload", {
            method: "POST",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, mime, base64 }),
          });
          const js = await resp.json();
          if (!resp.ok || !js.ok) throw new Error(js.error || "Upload failed");

          setStatus(`Uploaded to Drive: ${js.name} (id ${js.id})`, "ok");
        } catch (e) {
          console.error(e);
          setStatus("Drive upload failed: " + e.message, "err");
        }
      });

      checkAuth();
    </script>
  </body>
</html>
