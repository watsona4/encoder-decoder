<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Decoder Ring</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          "Segoe UI",
          Roboto,
          Arial;
        background: #fafafa;
        color: #111;
        padding: 30px;
      }
      button {
        font: inherit;
        padding: 8px 10px;
        cursor: pointer;
        background: #2563eb;
        color: #fff;
        border: 0;
        border-radius: 4px;
      }
      #status {
        margin-top: 15px;
        white-space: pre-wrap;
        font-family: monospace;
      }
      .overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        display: grid;
        place-items: center;
        z-index: 9999;
      }
      .panel {
        background: #fff;
        color: #111;
        padding: 16px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        width: min(420px, 90vw);
        text-align: center;
      }
    </style>
  </head>
  <body>
    <button id="go">Submit</button>
    <div id="status"></div>

    <script>
      (async () => {
        const go = document.getElementById("go");
        const statusEl = document.getElementById("status");
        const setStatus = (m) => (statusEl.textContent = m);

        go.addEventListener("click", async () => {
          try {
            setStatus("Waiting…");
            const raw = await openPasteOverlay();
            if (!raw) {
              setStatus("No data.");
              return;
            }

            // Split off filename header
            let name = "file.bin";
            let base64 = raw.trim();
            const m = /^FILENAME:(.+)\n([\s\S]*)$/.exec(base64);
            if (m) {
              name = m[1].trim();
              base64 = m[2].trim();
            }

            const upload_id = await chunkedSend(base64, (p) =>
              setStatus(`Encoding ${(p * 100).toFixed(1)}% (${name})`)
            );

            const res = await finishDrive(upload_id, name);
            setStatus(`✅ Encoded "${res.name}" (id ${res.id}).`);
          } catch (e) {
            setStatus("Error: " + (e.message || e));
          }
        });

        // Reuse previous chunked upload functions
        async function chunkedSend(base64Text, onProgress) {
          const start = await fetch("/api/chunk/start", { method: "POST" });
          const sjs = await start.json();
          if (!start.ok || !sjs.ok)
            throw new Error(sjs.error || "start failed");
          const upload_id = sjs.upload_id;
          const CHUNK = 512 * 1024;
          const total = base64Text.length;
          let seq = 0;
          for (let off = 0; off < total; off += CHUNK) {
            const data = base64Text.slice(off, off + CHUNK);
            const resp = await fetch("/api/chunk/append", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ upload_id, seq, data }),
            });
            const js = await resp.json();
            if (!resp.ok || !js.ok)
              throw new Error(js.error || "append failed");
            seq++;
            if (onProgress)
              onProgress(Math.min(1, (off + data.length) / total));
          }
          return upload_id;
        }

        async function finishDrive(upload_id, name) {
          const mime = "application/octet-stream";
          const resp = await fetch("/api/chunk/finish/drive", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ upload_id, name, mime }),
          });
          const js = await resp.json().catch(() => ({}));
          if (!resp.ok || !js.ok) throw new Error(js.error || resp.statusText);
          return js;
        }

        function openPasteOverlay() {
          return new Promise((resolve, reject) => {
            const o = document.createElement("div");
            o.className = "overlay";
            o.innerHTML =
              '<div class="panel">Go for it!</div>';
            document.body.appendChild(o);
            function done(t) {
              cleanup();
              resolve(t);
            }
            function cleanup() {
              o.remove();
              window.removeEventListener("keydown", key);
            }
            function key(e) {
              if (e.key === "Escape") {
                cleanup();
                reject(new Error("cancelled"));
              }
            }
            o.addEventListener("paste", (e) => {
              e.preventDefault();
              done(e.clipboardData.getData("text"));
            });
            window.addEventListener("keydown", key);
            o.tabIndex = -1;
            o.focus();
          });
        }
      })();
    </script>
  </body>
</html>
